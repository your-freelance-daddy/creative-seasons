<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Creative Pulse</title>
    <style>
        /* Import Caprasimo font */
        @import url('https://fonts.googleapis.com/css2?family=Caprasimo&display=swap');

        :root {
            --primary: #a855f7;
            --primary-glow: #a855f788;
            --secondary: #ec4899;
            --bg-dark: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-main: #ffffff;
            --text-muted: #94a3b8;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', Inter, -apple-system, sans-serif;
            background: #0f172a;
            color: var(--text-main);
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Animated Background --- */
        .ambient-light {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #0f172a 100%);
        }
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s infinite ease-in-out;
        }
        .orb-1 { width: 300px; height: 300px; background: var(--primary); top: -50px; left: -50px; animation-delay: 0s; }
        .orb-2 { width: 400px; height: 400px; background: var(--secondary); bottom: -100px; right: -50px; animation-delay: -5s; }
        .orb-3 { width: 200px; height: 200px; background: #6366f1; top: 40%; left: 60%; animation-delay: -10s; }

        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(30px, -30px); }
        }

        /* --- UI Layout --- */
        .container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            z-index: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            position: relative;
        }

        /* --- Header & Logo --- */
        .header {
            text-align: center;
            margin-bottom: 10px;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .logo-img {
            width: 180px;
            height: auto;
            filter: brightness(1.2); 
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .logo-img:hover { transform: scale(1.05) rotate(-2deg); }
        
        .platform-title {
            font-family: 'Caprasimo', cursive;
            font-size: 3rem; 
            font-weight: 800;
            margin-top: 10px;
            margin-bottom: 25px;
            color: #1e1b4b; 
            letter-spacing: 1.5px;
            text-shadow: 
                0 0 10px rgba(255, 255, 255, 0.8),
                0 0 25px rgba(255, 255, 255, 0.6),
                0 0 45px rgba(255, 255, 255, 0.4);
        }

        /* --- Glass Cards & General Components --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 28px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            transition: transform 0.2s ease, opacity 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .glass-panel::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.05), transparent);
            transform: skewX(-25deg); transition: 0.5s; pointer-events: none;
        }
        .glass-panel:hover::after { left: 150%; transition: 0.7s; }

        /* --- Buttons --- */
        .btn {
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
            display: inline-flex; justify-content: center; align-items: center; gap: 8px;
            text-decoration: none;
        }
        .btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 25px rgba(168, 85, 247, 0.5); }
        .btn:active { transform: scale(0.96); }
        
        .btn-secondary { background: rgba(255,255,255,0.1); box-shadow: none; border: 1px solid rgba(255,255,255,0.1); }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }

        .icon-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            width: 40px; height: 40px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
            font-size: 1.2rem;
        }
        .icon-btn:hover { background: rgba(236, 72, 153, 0.2); color: white; border-color: #ec4899; transform: rotate(10deg); }

        .story-btn {
            background: rgba(255, 255, 255, 0.15); 
            border: 1px solid var(--glass-border);
            color: #fff;
            font-size: 0.85rem;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 12px;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
            font-weight: 600;
            white-space: nowrap;
        }
        .story-btn:hover { 
            opacity: 1; 
            color: white; 
            border-color: var(--primary);
            background: rgba(168, 85, 247, 0.2);
            transform: translateY(-2px);
        }

        /* --- Footer Bar --- */
        .footer-bar {
            display: flex;
            justify-content: center; 
            gap: 20px; 
            align-items: center;
            width: 100%;
            max-width: 600px;
            padding: 0 20px;
            margin-top: auto;
            margin-bottom: 10px;
        }


        /* --- Other Elements --- */
        .view { display: none; animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .mode-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.07), rgba(255,255,255,0.02));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 145px;
            position: relative;
        }
        .mode-card:hover { 
            background: rgba(255,255,255,0.12); 
            transform: translateY(-5px) scale(1.02); 
            border-color: var(--primary);
            box-shadow: 0 10px 30px -10px rgba(168, 85, 247, 0.4);
        }
        .mode-emoji { font-size: 2.8rem; margin-bottom: 12px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
        .mode-name { font-weight: 800; color: white; margin-bottom: 5px; font-size: 1.1rem; }
        .mode-desc { font-size: 0.75rem; color: #cbd5e1; line-height: 1.4; max-width: 90%; }
        
        .progress-container { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 30px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 10px; width: 0%; transition: width 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 0 10px var(--primary); }
        
        .question-text { font-size: 1.5rem; font-weight: 800; margin-bottom: 25px; line-height: 1.35; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .option-btn {
            display: flex; align-items: center; width: 100%; text-align: left;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--glass-border);
            padding: 18px 22px; margin-bottom: 12px;
            border-radius: 16px; color: #cbd5e1;
            cursor: pointer; transition: 0.2s;
            font-size: 1rem; font-weight: 500;
        }
        .option-btn:hover { background: rgba(168, 85, 247, 0.15); border-color: var(--primary); color: white; padding-left: 26px; }
        .option-btn.selected { background: linear-gradient(90deg, var(--primary), #9333ea); border-color: var(--primary); color: white; font-weight: 700; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4); transform: scale(1.01); }
        
        .result-card { border-top: 5px solid var(--primary); }
        .result-header { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 2px; color: var(--secondary); margin-bottom: 15px; font-weight: 800; }
        .result-archetype { font-size: 2rem; font-weight: 900; margin-bottom: 20px; background: linear-gradient(135deg, #fff, #e9d5ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .typewriter-text { font-size: 1.15rem; line-height: 1.7; color: #e2e8f0; margin-bottom: 30px; border-left: 2px solid var(--glass-border); padding-left: 15px; }
        .cursor::after { content: '|'; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        
        .action-box { background: rgba(168, 85, 247, 0.15); border: 1px solid rgba(168, 85, 247, 0.3); padding: 20px; border-radius: 16px; margin-bottom: 25px; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 100; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal-content {
            background: #1e1b4b;
            border: 2px solid var(--primary);
            width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto;
            border-radius: 24px; padding: 30px;
            transform: translateY(20px); transition: 0.3s;
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.4);
        }
        .modal-overlay.open .modal-content { transform: translateY(0); }
        .story-text { font-size: 1rem; line-height: 1.7; color: #cbd5e1; margin-bottom: 15px; }
        .story-highlight { color: var(--primary); font-weight: 700; }
        
        .spark-item { padding: 20px; background: rgba(0,0,0,0.25); border-radius: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .spark-item:hover { border-color: var(--primary-glow); background: rgba(0,0,0,0.4); }
        
        .hidden { display: none; }
        .top-nav { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        
        /* Form elements */
        input[type="text"], textarea {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            padding: 16px;
            border-radius: 14px;
            color: white;
            font-size: 1rem;
            margin-bottom: 18px;
            outline: none;
            transition: 0.2s;
            font-family: inherit;
        }
        input[type="text"]:focus, textarea:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2); }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #e9d5ff; }

    </style>
</head>
<body>

    
<div class="ambient-light">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    
<div class="container">
        
        
<header class="header">
            
<a href="https://ekolitika.framer.website/" target="_blank">
                <img src="https://framerusercontent.com/images/NhZAoGoxBJzZIPWRIXCzVkkNuDA.png?scale-down-to=512" alt="EKOLITIKA Logo" class="logo-img">
            </a>
            
<div class="platform-title">Creative Pulse</div>
        </header>

        
<div id="view-onboarding" class="view active">
            <div class="glass-panel" style="text-align:center;">
                <h2 style="font-size:1.8rem; margin-bottom:15px; background: linear-gradient(to right, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Unstick your mind.</h2>
                <p style="color:#cbd5e1; margin-bottom:30px; line-height:1.6;">
                    A digital mentor for the creative community.<br>
                    Diagnose blocks, find inspiration, and get actionable advice.
                </p>
                <form id="onboardForm" style="text-align:left;">
                    <label>Your Name / Nickname</label>
                    <input type="text" id="userName" placeholder="e.g. Alex, Sam..." required autocomplete="off">
                    
                    <label>Your Creative Field</label>
                    <input type="text" id="userField" placeholder="e.g. Design, Education, Music..." required autocomplete="off">

                    <button type="submit" class="btn">Start Your Journey üöÄ</button>
                </form>
            </div>
        </div>

        
<div id="view-dashboard" class="view">
            <div class="top-nav">
                <div>
                    <div style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;">Welcome back</div>
                    <div style="font-size:1.4rem; font-weight:700;" id="dashName">Creator</div>
                </div>
                <button onclick="logout()" class="icon-btn" title="Reset Profile">‚èª</button>
            </div>

            <div class="glass-panel" style="padding:20px 20px 30px 20px;">
                <div style="text-align:center; margin-bottom:20px; font-weight:600; color:#e2e8f0;">Choose your mode</div>
                <div class="mode-grid">
                    <div class="mode-card" onclick="startMode('diagnose')">
                        <div class="mode-emoji">ü©∫</div>
                        <div class="mode-name">Diagnose</div>
                        <div class="mode-desc">Identify exactly why you are stuck.</div>
                    </div>
                    <div class="mode-card" onclick="startMode('inspire')">
                        <div class="mode-emoji">‚ú®</div>
                        <div class="mode-name">Inspire</div>
                        <div class="mode-desc">Refuel your creative energy tank.</div>
                    </div>
                    <div class="mode-card" onclick="startMode('brainstorm')">
                        <div class="mode-emoji">üí°</div>
                        <div class="mode-name">Brainstorm</div>
                        <div class="mode-desc">Break rules and think wild.</div>
                    </div>
                    <div class="mode-card" onclick="startMode('organize')">
                        <div class="mode-emoji">üì¶</div>
                        <div class="mode-name">Organize</div>
                        <div class="mode-desc">Turn chaos into tiny steps.</div>
                    </div>
                    <div class="mode-card" onclick="startMode('experiment')">
                        <div class="mode-emoji">üöÄ</div>
                        <div class="mode-name">Experiment</div>
                        <div class="mode-desc">Test ideas without fear.</div>
                    </div>
                    <div class="mode-card" style="border-style:dashed; opacity:0.8;" onclick="showSaved()">
                        <div class="mode-emoji">‚ö°</div>
                        <div class="mode-name">My Sparks</div>
                        <div class="mode-desc">Library of saved advice.</div>
                    </div>
                </div>
            </div>
        </div>

        
<div id="view-wizard" class="view">
            <div class="top-nav">
                <button onclick="goHome()" class="icon-btn" title="Exit">‚úï</button>
                <div style="font-weight:700; color:var(--primary);" id="wizardModeTitle">MODE</div>
                <div style="width:40px;"></div> 

</div>

            <div class="glass-panel">
                <div class="progress-container"><div class="progress-fill" id="progressBar"></div></div>
                
                <div id="questionContainer">
                    <div id="questionText" class="question-text">Question goes here...</div>
                    <div id="optionsArea"></div>
                    <textarea id="textInput" class="hidden" rows="3" placeholder="Type your thoughts here..."></textarea>
                </div>
                
                <button id="nextBtn" class="btn" style="margin-top:15px; opacity:0.5; pointer-events:none;" onclick="nextStep()">Continue &rarr;</button>
            </div>
        </div>

        
<div id="view-result" class="view">
            <div class="glass-panel result-card">
                <div class="result-header">Your Digital Mentor Says:</div>
                <div class="result-archetype" id="resArchetype">Loading...</div>
                
                
<div class="typewriter-text" id="resBody"><span class="cursor"></span></div>
                
                <div class="action-box hidden" id="resActionBox">
                    <strong style="color:var(--primary); display:block; margin-bottom:5px;">‚ö° TINY NEXT STEP:</strong>
                    <span id="resAction" style="font-size:1.1rem; font-weight:600; color:white;">Action...</span>
                </div>
                
                <div class="hidden" id="resButtons" style="display:flex; flex-direction:column; gap:10px;">
                    <button class="btn" onclick="saveResult()">Save this Spark üíæ</button>
                    <button class="btn btn-secondary" onclick="goHome()">Back to Modes</button>
                </div>
            </div>
        </div>

        
<div id="view-saved" class="view">
            <div class="top-nav">
                <button onclick="goHome()" class="icon-btn">‚Üê</button>
                <h3 style="margin:0;">Your Spark Library</h3>
                <div style="width:40px;"></div>
            </div>
            <div id="savedList" style="padding-bottom:50px;"></div>
        </div>

        
<footer class="footer-bar">
            <button class="story-btn" onclick="openStory()">Read the Origin Story üìñ</button>
            
            
<a href="https://ekolitika.framer.website/" target="_blank" class="story-btn">
                With üíö for the creative community, made by EKOLiTiKA
            </a>
        </footer>

    </div>

    
<div class="modal-overlay" id="storyModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0; font-size:1.5rem; color:var(--primary);">Born from Struggle</h3>
                <button onclick="closeStory()" class="icon-btn">‚úï</button>
            </div>
            
            <div id="storyContent" style="margin-bottom: 20px;">
                </div>
            
            <div style="margin-top:30px; padding-top:20px; border-top:1px solid var(--glass-border); text-align:center; font-size:0.9rem; color:#cbd5e1;">
                Built by <b>EKOLiTiKA</b> ‚Äî an NGO learning sustainability from nature and applying circular thinking to creativity.
            </div>
            <button class="btn" style="margin-top:20px;" onclick="closeStory()">Got it!</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Configuration placeholder (MUST be here if you expect Firebase to work)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const FIREBASE_COLLECTION = 'sparks';

        // --- CORE DATA STORE OBJECT ---
        const DataStore = {
            app: null,
            db: null,
            auth: null,
            userId: null,
            isInitialized: false,

            init: async function() {
                if (Object.keys(firebaseConfig).length > 0) {
                    try {
                        this.app = initializeApp(firebaseConfig);
                        this.db = getFirestore(this.app);
                        this.auth = getAuth(this.app);
                        this.isInitialized = true;
                        
                        // Start Authentication
                        onAuthStateChanged(this.auth, (user) => {
                            if (user) {
                                this.userId = user.uid;
                                console.log("Firebase Auth Success. User ID:", this.userId);
                            } else {
                                console.log("Attempting Anonymous Sign-in...");
                                (initialAuthToken 
                                    ? signInWithCustomToken(this.auth, initialAuthToken) 
                                    : signInAnonymously(this.auth))
                                .catch(e => console.error("Anonymous Sign-in Failed:", e));
                            }
                        });
                    } catch (e) {
                        console.error("Firebase Init Failed (Check Config):", e);
                    }
                } else {
                    console.warn("Firebase configuration is missing. Saving will be disabled.");
                }
                
                // Always onboard user based on local storage profile
                window.onboardUser(); 
            },

            getUserCollection: function(collectionName) {
                if (!this.db || !this.userId) {
                    return null;
                }
                // Path: /artifacts/{appId}/users/{userId}/sparks
                return collection(this.db, `artifacts/${appId}/users/${this.userId}/${collectionName}`);
            },

            saveSpark: async function(sparkData) {
                if (!this.isInitialized || !this.userId) {
                    window.alertModal("Error ‚ùå", "Cannot save. Database features are currently unavailable, or user authentication is still pending. Try again in a moment, or check your console for Firebase Config errors.");
                    return false;
                }

                try {
                    const collectionRef = this.getUserCollection(FIREBASE_COLLECTION);
                    await addDoc(collectionRef, {
                        ...sparkData,
                        timestamp: new Date().toISOString()
                    });
                    window.alertModal("Saved! üíæ", `Your spark, '${sparkData.archetype}', has been saved to your library.`);
                    return true;
                } catch (e) {
                    console.error("Error adding document: ", e);
                    window.alertModal("Error üö®", `Failed to save the spark: ${e.message}`);
                    return false;
                }
            },
            
            // Set up real-time listener for the user's saved sparks.
            setupSavedDataListener: function(callback) {
                // Clear existing listener if any
                if (this.unsubscribeSavedData) {
                    this.unsubscribeSavedData();
                    this.unsubscribeSavedData = null;
                }
                
                if (!this.isInitialized || !this.userId) {
                    // This message is shown immediately if saving is impossible
                    callback([]);
                    const listEl = document.getElementById('savedList');
                    if (listEl) {
                        listEl.innerHTML = '<p style="color:#f87171; text-align:center; padding: 20px;">Database features are unavailable. Please ensure your Firebase config is set up and your connection is stable.</p>';
                    }
                    return;
                }
                
                const collectionRef = this.getUserCollection(FIREBASE_COLLECTION);
                if (!collectionRef) return;

                const q = query(collectionRef, orderBy("timestamp", "desc"), limit(20));

                this.unsubscribeSavedData = onSnapshot(q, (snapshot) => {
                    const savedSparks = [];
                    snapshot.forEach((doc) => {
                        savedSparks.push({ id: doc.id, ...doc.data() });
                    });
                    callback(savedSparks); 
                }, (error) => {
                    console.error("Error listening to saved sparks:", error);
                    const listEl = document.getElementById('savedList');
                    if (listEl) {
                        listEl.innerHTML = `<p style="color:#f87171; text-align:center; padding: 20px;">Error loading sparks: ${error.message}</p>`;
                    }
                });
            },

            // Allows the general script to stop the listener when changing views
            unsubscribeSavedData: null,
        };

        // EXPOSE THE PUBLIC INTERFACE TO THE WINDOW OBJECT
        window.DataStore = DataStore;
        
        // Start initialization
        window.addEventListener('load', () => DataStore.init());
    </script>

<script>
    /* * All functions here now interact with the DataStore object exposed by the module.
    * This resolves the scope and access issues that caused the saving errors.
    */
    
    const content = {
        diagnose: {
            steps: [
                { q: "Right now, how does your creative block feel?", type:"choice", opts: ["Foggy & Overwhelming", "Empty & Drained", "Anxious & Fast", "Boring & Repetitive"] },
                { q: "What is the story you are telling yourself?", type:"choice", opts: ["'I'm not good enough'", "'I'm out of time'", "'This idea is stupid'", "'I'm don't know where to start'"] },
                { q: "Describe the specific project or problem in one sentence:", type:"text" }
            ],
            archetypes: {
                "Foggy & Overwhelming": {
                    archetype: "The Overwhelmed Navigator",
                    advice: "Your issue is likely structural‚Äîtoo many paths open, no clear destination. You need to narrow your focus and create strict boundaries to reduce cognitive load. Stop starting new things.",
                    action: "Pick one (and only one) task to complete today. Break that task down into 3-5 sub-steps."
                },
                "Empty & Drained": {
                    archetype: "The Burnt-Out Well",
                    advice: "Your well is dry. This is not a productivity problem; it's a depletion problem. The cure is not more work, but genuine rest, input, and zero expectation play. You must detach your identity from output.",
                    action: "Schedule 30 minutes of non-productive, non-screen time today (e.g., listening to music, sketching a random object, walking outside)."
                },
                "Anxious & Fast": {
                    archetype: "The Perfectionist Paralytic",
                    advice: "You are stuck because the gap between your aspiration and your current output feels immense. This anxiety leads to procrastination. You need to create an ugly first draft, fast. Perfectionism is a fear of vulnerability.",
                    action: "Set a 10-minute timer and produce the worst possible version of your work. Do not edit, judge, or stop until the timer ends."
                },
                "Boring & Repetitive": {
                    archetype: "The Stale Routine",
                    advice: "Your process has become mechanical, and your work reflects it. You've solved the same problem too many times. The solution is to introduce novelty, a new constraint, or a completely foreign input to disrupt your pattern recognition.",
                    action: "Find one piece of art/music/design outside your usual genre and try to identify three core principles you could steal."
                }
            }
        },
        inspire: {
            steps: [
                { q: "What kind of fuel do you need?", type:"choice", opts: ["Soft comfort (Rest)", "Hard truth (Kick)", "New input (Awe)", "Just a distraction"] },
                { q: "Who is an artist or creator you are jealous of right now?", type:"text" },
                { q: "If you couldn't fail, what would you make today?", type:"text" }
            ],
            archetypes: {
                "Soft comfort (Rest)": {
                    archetype: "The Compassionate Gardener",
                    advice: "You don't need inspiration; you need validation. Give yourself permission to pause. Inspiration thrives in the space *after* the effort, not during it. Treat yourself like your best client.",
                    action: "Write a short note of self-compassion, acknowledging your current effort, then close your work for 30 minutes without guilt."
                },
                "Hard truth (Kick)": {
                    archetype: "The Bold Challenger",
                    advice: "You know what needs to be done, but you're avoiding the difficult choice or task. The hard truth is that resistance is the measure of the importance of your task. Stop looking for shortcuts and embrace the grind.",
                    action: "Identify the one task you dread most. Tell one person you'll complete it by the end of the day."
                },
                "New input (Awe)": {
                    archetype: "The Curious Alchemist",
                    advice: "Your mind is craving cross-pollination. Break out of your usual sources. Find inspiration in a completely unrelated field‚Äîscience, history, nature‚Äîand try to map its principles to your creative challenge.",
                    action: "Search for 'oldest living thing' or 'most complex natural structure' and spend 15 minutes thinking about how it operates. Apply its rules to your project."
                },
                "Just a distraction": {
                    archetype: "The Playful Saboteur",
                    advice: "Distraction isn't avoidance; it's often the mind's way of processing. Embrace the 'distraction' that is low-stakes and fun. This is where serendipity hides. Don't fight it, integrate it.",
                    action: "Spend 20 minutes doing something completely unrelated to your project that you enjoy, but set a firm timer."
                }
            }
        },
        brainstorm: {
             steps: [
                { q: "Pick a constraint to force creativity:", type:"choice", opts: ["Explain it to a 5-year-old", "Do it with $0 budget", "Make the 'evil' version", "Finish it in 15 minutes"] },
                { q: "What is the core problem you want to solve?", type:"text" },
                { q: "Write down 3 terrible, silly, or illegal ideas. Go.", type:"text" }
            ],
            archetypes: {
                "Explain it to a 5-year-old": {
                    archetype: "The Clarity Simplifier",
                    advice: "The best ideas are often the clearest. By simplifying, you strip away layers of complexity that hide the core value. You must find the single, universal truth in your work.",
                    action: "Write a one-sentence, non-jargon explanation of your project. If you can't, you haven't simplified enough."
                },
                "Do it with $0 budget": {
                    archetype: "The Resourceful Inventor",
                    advice: "Budget constraints force innovation and prioritize concept over polish. This reveals the project's true essence. You are learning to substitute cost with cleverness.",
                    action: "List the three most expensive/resource-intensive elements of your idea. Now, find three completely free alternatives for each."
                },
                "Make the 'evil' version": {
                    archetype: "The Shadow Artist",
                    advice: "Exploring the opposite perspective (the 'evil' or destructive version) highlights the purpose and integrity of the original idea. This negative space often reveals powerful, hidden solutions.",
                    action: "Imagine your project was designed to fail its audience. Write down the first three steps you would take to achieve that failure."
                },
                "Finish it in 15 minutes": {
                    archetype: "The Speed Curator",
                    advice: "Extreme time constraints prioritize execution over deliberation. You are fighting the urge to overthink. This rapid prototyping generates raw, unjudged material you can refine later.",
                    action: "Do a 15-minute 'stream of consciousness' brain dump about your topic. Do not lift your pen/fingers. Quantity over quality."
                }
            }
        },
        organize: {
             steps: [
                { q: "How many tabs/tasks are open in your brain?", type:"choice", opts: ["1-3 (Clean)", "4-10 (Cluttered)", "10+ (Disaster)", "System overload"] },
                { q: "Which single task is making you feeling guilty?", type:"text" },
                { q: "What is the absolute smallest first step?", type:"text" }
            ],
            archetypes: {
                "1-3 (Clean)": {
                    archetype: "The Focused Builder",
                    advice: "Your structure is generally sound, but you might be over-optimizing. You need to inject momentum. The focus is now on disciplined, incremental execution.",
                    action: "Commit to working on your project for 25 minutes (Pomodoro technique) right now, ignoring all other notifications."
                },
                "4-10 (Cluttered)": {
                    archetype: "The Prioritizing Architect",
                    advice: "The problem isn't complexity, it's poor prioritization. You must ruthlessly identify the 20% of tasks that will deliver 80% of the value. Stop multi-tasking and sequence your work.",
                    action: "List your 10 open tasks. Erase 5 of them immediately (they were never important). Sequence the remaining 5."
                },
                "10+ (Disaster)": {
                    archetype: "The Chaos Commander",
                    advice: "You are overwhelmed by quantity. Your first project is not the creative one, but the organizational one. You need an 'information triage' to sort, discard, and contain the sprawl.",
                    action: "Spend 20 minutes creating only *one* list (in a notebook, or app) of every single project/idea/task you feel obligated to do. Do not do any of them yet."
                },
                "System overload": {
                    archetype: "The Mental Detox",
                    advice: "Your brain is exhausted from holding too much information. You are burning energy on remembering, not creating. Externalize everything to a trusted system, then step away.",
                    action: "Clear your desk/screen completely. Then, capture the first 3 things that come to mind related to your project and immediately stop."
                }
            }
        },
        experiment: {
             steps: [
                { q: "How risky does this feel?", type:"choice", opts: ["Terrifying", "Uncomfortable", "Exciting", "Safe"] },
                { q: "What is the worst REALISTIC outcome?", type:"text" },
                { q: "What is the smallest thing you can test or change right now?", type:"text" }
            ],
            archetypes: {
                "Terrifying": {
                    archetype: "The Calculated Leaper",
                    advice: "The risk feels high because you've attached too much weight to the single outcome. De-risk by designing micro-experiments that fail small, fast, and cheaply. The goal is learning, not success.",
                    action: "Design a test that takes less than an hour, the results of which you will ignore if they're negative. (Example: a single social media post, a 5-minute prototype)."
                },
                "Uncomfortable": {
                    archetype: "The Edge Walker",
                    advice: "You are in the optimal zone‚Äîjust past comfortable, but not paralyzing. Lean into this friction. Friction generates heat, and heat forges innovation. Increase the intensity slightly.",
                    action: "Identify the element of your project you are most unsure about. Immediately start working on *that* element for 15 minutes."
                },
                "Exciting": {
                    archetype: "The High-Velocity Prototyper",
                    advice: "Energy is high, but risk management is needed. Channel this excitement into disciplined, fast-paced execution. Avoid over-scoping. Focus on a Minimum Viable Test (MVT).",
                    action: "Before you start, clearly define the single metric of success for your next hour of work (e.g., 'finish chapter 1 outline', 'get 5 feedback responses')."
                },
                "Safe": {
                    archetype: "The Iterative Improver",
                    advice: "You are likely refining something that is already good, but not great. To find the next leap, you must intentionally break something. Introduce an element that feels wrong or awkward.",
                    action: "Choose a design/process principle you live by (e.g., 'always minimalist'). For 30 minutes, violate that principle ruthlessly and see what happens."
                }
            }
        }
    };

    let userProfile = {};
    let currentMode = null;
    let currentStep = 0;
    let answers = [];
    const TYPING_SPEED = 20;

    // --- Helper Functions ---

    function setView(viewId) {
        document.querySelectorAll('.view').forEach(view => {
            view.classList.remove('active');
        });
        const targetView = document.getElementById(`view-${viewId}`);
        if (targetView) {
            targetView.classList.add('active');
        } else {
             console.error(`Error: View element with ID "view-${viewId}" not found in the DOM.`);
        }
    }

    window.alertModal = function(title, bodyHTML) {
        const modal = document.getElementById('storyModal');
        modal.querySelector('h3').textContent = title;
        modal.querySelector('#storyContent').innerHTML = bodyHTML; 
        modal.querySelector('.btn').textContent = "Close";
        modal.querySelector('.btn').onclick = window.closeStory; 
        modal.classList.add('open');
    }

    // --- Onboarding & Profile Management ---

    function loadProfile() {
        const profile = localStorage.getItem('userProfile');
        userProfile = profile ? JSON.parse(profile) : {};
    }

    function saveProfile() {
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
    }

    window.onboardUser = function() {
        loadProfile();
        const initialView = userProfile.name ? 'dashboard' : 'onboarding';
        
        if (initialView === 'dashboard') {
            document.getElementById('dashName').textContent = userProfile.name;
            setView('dashboard');
        } else {
            setView('onboarding');
        }
    }

    window.goHome = function() {
        currentMode = null;
        currentStep = 0;
        answers = [];
        setView('dashboard');
        // Stop the real-time listener when leaving the saved view
        if (window.DataStore && window.DataStore.unsubscribeSavedData) {
            window.DataStore.unsubscribeSavedData();
        }
    }

    window.logout = function() {
        localStorage.removeItem('userProfile');
        localStorage.removeItem('currentResult'); 
        userProfile = {};
        goHome();
    }

    document.getElementById('onboardForm').addEventListener('submit', function(e) {
        e.preventDefault();
        userProfile.name = document.getElementById('userName').value.trim();
        userProfile.field = document.getElementById('userField').value.trim();
        saveProfile();
        window.onboardUser();
    });

    // --- Mode & Wizard Flow ---

    window.startMode = function(mode) {
        currentMode = mode;
        currentStep = 0;
        answers = [];
        document.getElementById('wizardModeTitle').textContent = mode.toUpperCase();
        loadStep(currentStep);
        setView('wizard');
    }

    function loadStep(stepIndex) {
        const modeData = content[currentMode];
        if (!modeData) return;

        const totalSteps = modeData.steps.length;
        const step = modeData.steps[stepIndex];

        const progress = ((stepIndex + 1) / totalSteps) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;

        document.getElementById('questionText').textContent = step.q;
        
        const nextBtn = document.getElementById('nextBtn');
        const optionsArea = document.getElementById('optionsArea');
        const textInput = document.getElementById('textInput');
        
        optionsArea.innerHTML = '';
        textInput.value = '';
        textInput.classList.add('hidden');
        nextBtn.style.opacity = 0.5;
        nextBtn.style.pointerEvents = 'none';

        if (step.type === 'choice') {
            optionsArea.style.display = 'block';
            step.opts.forEach(option => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.textContent = option;
                btn.onclick = () => selectOption(option, btn);
                optionsArea.appendChild(btn);
            });
        } else if (step.type === 'text') {
            optionsArea.style.display = 'none';
            textInput.classList.remove('hidden');
            textInput.oninput = () => {
                if (textInput.value.trim().length > 5) {
                    nextBtn.style.opacity = 1;
                    nextBtn.style.pointerEvents = 'auto';
                } else {
                    nextBtn.style.opacity = 0.5;
                    nextBtn.style.pointerEvents = 'none';
                }
            };
        }
    }

    function selectOption(option, selectedBtn) {
        document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
        selectedBtn.classList.add('selected');
        answers[currentStep] = option;
        
        const nextBtn = document.getElementById('nextBtn');
        nextBtn.style.opacity = 1;
        nextBtn.style.pointerEvents = 'auto';
    }

    window.nextStep = function() {
        const step = content[currentMode].steps[currentStep];
        let answer;

        if (step.type === 'choice') {
            answer = answers[currentStep];
        } else if (step.type === 'text') {
            answer = document.getElementById('textInput').value.trim();
        }

        if (!answer) {
            alertModal("Hold On!", "Please provide an answer before continuing.");
            return;
        }

        answers[currentStep] = answer;
        currentStep++;

        if (currentStep < content[currentMode].steps.length) {
            loadStep(currentStep);
        } else {
            generateResult();
        }
    }
    
    // --- Result Generation ---

    function generateResult() {
        setView('result');
        const modeData = content[currentMode];
        const keyAnswer = answers[0];
        
        let result = modeData.archetypes[keyAnswer] || {
            archetype: "The Insight Generator",
            advice: "Based on your unique inputs, we see a blend of challenges. The core advice is to reduce complexity and prioritize radical self-care. Your biggest hurdle is internal expectation.",
            action: "Write down three things you accomplished last week (no matter how small) to counteract the voice of self-doubt."
        };
        
        const lastInput = answers[answers.length - 1];
        
        // Save result locally to be ready for saving to Firestore
        const currentResult = {
            mode: currentMode,
            archetype: result.archetype,
            advice: result.advice,
            action: result.action,
            context: lastInput // Save last input for better context
        };
        localStorage.setItem('currentResult', JSON.stringify(currentResult));

        // Update DOM
        document.getElementById('resArchetype').textContent = result.archetype;
        document.getElementById('resAction').textContent = result.action;
        document.getElementById('resActionBox').classList.remove('hidden');
        document.getElementById('resButtons').classList.remove('hidden');

        // Typewriter effect
        const resBodyEl = document.getElementById('resBody');
        resBodyEl.textContent = ''; 
        typewriter(resBodyEl, result.advice);
    }

    function typewriter(element, text, i = 0) {
        if (i < text.length) {
            element.innerHTML = text.substring(0, i + 1) + '<span class="cursor"></span>';
            setTimeout(() => typewriter(element, text, i + 1), TYPING_SPEED);
        } else {
            element.innerHTML = text;
        }
    }

    // --- Saving and Library ---

    window.saveResult = function() {
        const resultData = JSON.parse(localStorage.getItem('currentResult'));
        if (!resultData) {
            alertModal("Error", "No result found to save. Please run a diagnosis first.");
            return;
        }
        
        // **CRITICAL FIX**: Calling the saveSpark function from the DataStore module
        window.DataStore.saveSpark(resultData);
    }

    window.showSaved = function() {
        setView('saved');
        const listEl = document.getElementById('savedList');
        listEl.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">Checking for sparks...</div>';
        
        // **CRITICAL FIX**: Calling the setup listener from the DataStore module
        if (window.DataStore) {
            window.DataStore.setupSavedDataListener(window.displaySavedSparks);
        }
    }

    window.displaySavedSparks = function(sparks) {
        const listEl = document.getElementById('savedList');
        listEl.innerHTML = '';

        if (sparks.length === 0) {
            listEl.innerHTML = `
                <div class="glass-panel" style="text-align:center; opacity:0.7;">
                    <div style="font-size:3rem; margin-bottom:15px;">üßê</div>
                    <p style="color:#cbd5e1;">Your Spark Library is empty. Go through a mode and click 'Save this Spark'!</p>
                </div>
            `;
            return;
        }

        sparks.forEach(spark => {
            const date = new Date(spark.timestamp).toLocaleDateString();
            const modeName = spark.mode.charAt(0).toUpperCase() + spark.mode.slice(1);
            const sparkItem = document.createElement('div');
            sparkItem.className = 'spark-item';
            sparkItem.innerHTML = `
                <div style="font-size:0.8rem; color:var(--secondary); font-weight:700; display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>${modeName} Result</span> 
                    <span>${date}</span>
                </div>
                <div style="font-size:1.4rem; font-weight:800; color:white; margin-bottom:10px;">${spark.archetype}</div>
                <div style="font-size:0.9rem; color:#cbd5e1;">
                    <strong style="color:var(--primary);">Advice:</strong> ${spark.advice.substring(0, 100)}...
                </div>
                <div style="font-size:0.9rem; color:#cbd5e1; margin-top:5px;">
                    <strong style="color:#ec4899;">Action:</strong> ${spark.action}
                </div>
            `;
            sparkItem.onclick = () => alertModal(
                `${modeName}: ${spark.archetype}`, 
                `<p class="story-text">${spark.advice}</p><p class="story-text" style="margin-top:15px; color:var(--primary); font-weight:700;">Tiny Next Step: ${spark.action}</p>`
            );
            listEl.appendChild(sparkItem);
        });
    }

    // --- Story/Modal Functions ---

    window.openStory = function() {
        const modal = document.getElementById('storyModal');
        modal.querySelector('h3').textContent = "Born from Struggle";
        
        modal.querySelector('#storyContent').innerHTML = `
            <p class="story-text">
                In 2025, a team joined <a href="https://ekolitika.framer.website/project/the-creative-mess" target="_blank" class="story-highlight" style="text-decoration: underline;">The Creative Mess</a>‚Äîan Erasmus+ course that proved creativity isn't magic. It's a cycle: brainstorm, organize, rest, inspire, experiment, repeat.
            </p>
            <p class="story-text">
                The problem? Most tools feed you empty motivation or treat creativity like a factory line. Neither helps when you're actually stuck.
            </p>
            <p class="story-text">
                So we built <span class="story-highlight">Creative Pulse</span>. A free tool that diagnoses your block, tells you what you actually need, and gives you real feedback‚Äînot fluff.
            </p>
            <p class="story-text">
                From stuck to unstuck. Idea to action. Exhaustion to rhythm.
            </p>
        `;
        
        modal.querySelector('.btn').textContent = "Got it!";
        modal.querySelector('.btn').onclick = window.closeStory;
        modal.classList.add('open');
    }

    window.closeStory = function() {
        document.getElementById('storyModal').classList.remove('open');
    }

</script>

</body>
</html>
