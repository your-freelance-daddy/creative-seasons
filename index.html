<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Creative Pulse | EKOLITIKA</title>
    <style>
        /* Import Caprasimo font */
        @import url('https://fonts.googleapis.com/css2?family=Caprasimo&display=swap');

        :root {
            --primary: #a855f7;
            --primary-glow: #a855f788;
            --secondary: #ec4899;
            --bg-dark: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-main: #ffffff;
            --text-muted: #94a3b8;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', Inter, -apple-system, sans-serif;
            background: #0f172a;
            color: var(--text-main);
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Animated Background --- */
        .ambient-light {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #0f172a 100%);
        }
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s infinite ease-in-out;
        }
        .orb-1 { width: 300px; height: 300px; background: var(--primary); top: -50px; left: -50px; animation-delay: 0s; }
        .orb-2 { width: 400px; height: 400px; background: var(--secondary); bottom: -100px; right: -50px; animation-delay: -5s; }
        .orb-3 { width: 200px; height: 200px; background: #6366f1; top: 40%; left: 60%; animation-delay: -10s; }

        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(30px, -30px); }
        }

        /* --- UI Layout --- */
        .container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            z-index: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            position: relative;
        }

        /* --- Header & Logo --- */
        .header {
            text-align: center;
            margin-bottom: 10px;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .logo-img {
            width: 180px;
            height: auto;
            filter: brightness(1.2); 
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .logo-img:hover { transform: scale(1.05) rotate(-2deg); }
        
        /* UPDATED: Platform Title Style - Dark Text with Bigger White Glow */
        .platform-title {
            font-family: 'Caprasimo', cursive;
            font-size: 3rem; 
            font-weight: 800; /* Max boldness */
            margin-top: 10px;
            margin-bottom: 25px;
            
            /* Dark purple text color, almost background */
            color: #1e1b4b; 
            
            /* Ensure no unwanted background/stroke effects */
            background: none;
            -webkit-background-clip: unset;
            -webkit-text-fill-color: unset;
            -webkit-text-stroke: none; 
            
            letter-spacing: 1.5px;
            
            /* Bigger, rich white glow */
            text-shadow: 
                0 0 10px rgba(255, 255, 255, 0.8), /* Inner bright core glow, slightly bigger */
                0 0 25px rgba(255, 255, 255, 0.6), /* Wider, semi-transparent glow */
                0 0 45px rgba(255, 255, 255, 0.4); /* Even wider, softer halo */
        }

        /* --- Glass Cards & General Components --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 28px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            transition: transform 0.2s ease, opacity 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .glass-panel::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.05), transparent);
            transform: skewX(-25deg); transition: 0.5s; pointer-events: none;
        }
        .glass-panel:hover::after { left: 150%; transition: 0.7s; }

        /* --- Buttons --- */
        .btn {
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
            display: inline-flex; justify-content: center; align-items: center; gap: 8px;
            text-decoration: none;
        }
        .btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 25px rgba(168, 85, 247, 0.5); }
        .btn:active { transform: scale(0.96); }
        
        .btn-secondary { background: rgba(255,255,255,0.1); box-shadow: none; border: 1px solid rgba(255,255,255,0.1); }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }

        .icon-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            width: 40px; height: 40px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
            font-size: 1.2rem;
        }
        .icon-btn:hover { background: rgba(236, 72, 153, 0.2); color: white; border-color: #ec4899; transform: rotate(10deg); }

        /* Existing Story Button Style */
        .story-btn {
            background: rgba(255, 255, 255, 0.15); 
            border: 1px solid var(--glass-border);
            color: #fff;
            font-size: 0.85rem;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 12px;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
            font-weight: 600;
            white-space: nowrap; /* Prevent text wrap for the long footer button */
        }
        .story-btn:hover { 
            opacity: 1; 
            color: white; 
            border-color: var(--primary);
            background: rgba(168, 85, 247, 0.2);
            transform: translateY(-2px);
        }

        /* --- Footer Bar --- */
        .footer-bar {
            display: flex;
            justify-content: center; 
            gap: 20px; 
            align-items: center;
            width: 100%;
            max-width: 600px;
            padding: 0 20px;
            margin-top: auto; /* Push to bottom of container */
            margin-bottom: 10px;
        }


        /* --- Other Elements --- */
        .view { display: none; animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .mode-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.07), rgba(255,255,255,0.02));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 145px;
            position: relative;
        }
        .mode-card:hover { 
            background: rgba(255,255,255,0.12); 
            transform: translateY(-5px) scale(1.02); 
            border-color: var(--primary);
            box-shadow: 0 10px 30px -10px rgba(168, 85, 247, 0.4);
        }
        .mode-emoji { font-size: 2.8rem; margin-bottom: 12px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
        .mode-name { font-weight: 800; color: white; margin-bottom: 5px; font-size: 1.1rem; }
        .mode-desc { font-size: 0.75rem; color: #cbd5e1; line-height: 1.4; max-width: 90%; }
        
        .progress-container { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 30px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 10px; width: 0%; transition: width 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 0 10px var(--primary); }
        
        .question-text { font-size: 1.5rem; font-weight: 800; margin-bottom: 25px; line-height: 1.35; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .option-btn {
            display: flex; align-items: center; width: 100%; text-align: left;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--glass-border);
            padding: 18px 22px; margin-bottom: 12px;
            border-radius: 16px; color: #cbd5e1;
            cursor: pointer; transition: 0.2s;
            font-size: 1rem; font-weight: 500;
        }
        .option-btn:hover { background: rgba(168, 85, 247, 0.15); border-color: var(--primary); color: white; padding-left: 26px; }
        .option-btn.selected { background: linear-gradient(90deg, var(--primary), #9333ea); border-color: var(--primary); color: white; font-weight: 700; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4); transform: scale(1.01); }
        
        .result-card { border-top: 5px solid var(--primary); }
        .result-header { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 2px; color: var(--secondary); margin-bottom: 15px; font-weight: 800; }
        .result-archetype { font-size: 2rem; font-weight: 900; margin-bottom: 20px; background: linear-gradient(135deg, #fff, #e9d5ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .typewriter-text { font-size: 1.15rem; line-height: 1.7; color: #e2e8f0; margin-bottom: 30px; border-left: 2px solid var(--glass-border); padding-left: 15px; }
        .cursor::after { content: '|'; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        
        .action-box { background: rgba(168, 85, 247, 0.15); border: 1px solid rgba(168, 85, 247, 0.3); padding: 20px; border-radius: 16px; margin-bottom: 25px; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 100; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal-content {
            background: #1e1b4b;
            border: 2px solid var(--primary);
            width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto;
            border-radius: 24px; padding: 30px;
            transform: translateY(20px); transition: 0.3s;
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.4);
        }
        .modal-overlay.open .modal-content { transform: translateY(0); }
        .story-text { font-size: 1rem; line-height: 1.7; color: #cbd5e1; margin-bottom: 15px; }
        .story-highlight { color: var(--primary); font-weight: 700; }
        
        .spark-item { padding: 20px; background: rgba(0,0,0,0.25); border-radius: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .spark-item:hover { border-color: var(--primary-glow); background: rgba(0,0,0,0.4); }
        
        .hidden { display: none; }
        .top-nav { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        
        /* Form elements */
        input[type="text"], textarea {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            padding: 16px;
            border-radius: 14px;
            color: white;
            font-size: 1rem;
            margin-bottom: 18px;
            outline: none;
            transition: 0.2s;
            font-family: inherit;
        }
        input[type="text"]:focus, textarea:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2); }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #e9d5ff; }

    </style>
</head>
<body>

    
<div class="ambient-light">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    
<div class="container">
        
        
<header class="header">
            
<a href="https://ekolitika.framer.website/" target="_blank">
                <img src="https://framerusercontent.com/images/NhZAoGoxBJzZIPWRIXCzVkkNuDA.png?scale-down-to=512" alt="EKOLITIKA Logo" class="logo-img">
            </a>
            
<div class="platform-title">Creative Pulse</div>
        </header>

        
<div id="view-onboarding" class="view active">
            <div class="glass-panel" style="text-align:center;">
                <h2 style="font-size:1.8rem; margin-bottom:15px; background: linear-gradient(to right, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Unstick your mind.</h2>
                <p style="color:#cbd5e1; margin-bottom:30px; line-height:1.6;">
                    A digital mentor for the creative community.<br>
                    Diagnose blocks, find inspiration, and get actionable advice.
                </p>
                <form id="onboardForm" style="text-align:left;">
                    <label>Your Name / Nickname</label>
                    <input type="text" id="userName" placeholder="e.g. Alex, Sam..." required autocomplete="off">
                    
                    <label>Your Creative Field</label>
                    <input type="text" id="userField" placeholder="e.g. Design, Education, Music..." required autocomplete="off">

                    <button type="submit" class="btn">Start Your Journey üöÄ</button>
                </form>
            </div>
        </div>

        
<div id="view-dashboard" class="view">
            <div class="top-nav">
                <div>
                    <div style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;">Welcome back</div>
                    <div style="font-size:1.4rem; font-weight:700;" id="dashName">Creator</div>
                </div>
                <button onclick="logout()" class="icon-btn" title="Reset Profile">‚èª</button>
            </div>

            <div class="glass-panel" style="padding:20px 20px 30px 20px;">
                <div style="text-align:center; margin-bottom:20px; font-weight:600; color:#e2e8f0;">Choose your mode</div>
                <div class="mode-grid">
                    <div class="mode-card" onclick="startMode('diagnose')">
                        <div class="mode-emoji">ü©∫</div>
                        <div class="mode-name">Diagnose</div>
                        <div class="mode-desc">Identify exactly why you are stuck.</div>
                    </div>
                    <div class="mode-card" onclick="startMode('inspire')">
                        <div class="mode-emoji">‚ú®</div>
                        <div class="mode-name">Inspire</div>
                        <div class="mode-desc">Refuel your creative energy tank.</div>
                    </div>
                    <div class="mode-card" onclick="startMode('brainstorm')">
                        <div class="mode-emoji">üí°</div>
                        <div class="mode-name">Brainstorm</div>
                        <div class="mode-desc">Break rules and think wild.</div>
                    </div>
                    <div class="mode-card" onclick="startMode('organize')">
                        <div class="mode-emoji">üì¶</div>
                        <div class="mode-name">Organize</div>
                        <div class="mode-desc">Turn chaos into tiny steps.</div>
                    </div>
                    <div class="mode-card" onclick="startMode('experiment')">
                        <div class="mode-emoji">üöÄ</div>
                        <div class="mode-name">Experiment</div>
                        <div class="mode-desc">Test ideas without fear.</div>
                    </div>
                    <div class="mode-card" style="border-style:dashed; opacity:0.8;" onclick="showSaved()">
                        <div class="mode-emoji">‚ö°</div>
                        <div class="mode-name">My Sparks</div>
                        <div class="mode-desc">Library of saved advice.</div>
                    </div>
                </div>
            </div>
        </div>

        
<div id="view-wizard" class="view">
            <div class="top-nav">
                <button onclick="goHome()" class="icon-btn" title="Exit">‚úï</button>
                <div style="font-weight:700; color:var(--primary);" id="wizardModeTitle">MODE</div>
                <div style="width:40px;"></div> 

</div>

            <div class="glass-panel">
                <div class="progress-container"><div class="progress-fill" id="progressBar"></div></div>
                
                <div id="questionContainer">
                    <div id="questionText" class="question-text">Question goes here...</div>
                    <div id="optionsArea"></div>
                    <textarea id="textInput" class="hidden" rows="3" placeholder="Type your thoughts here..."></textarea>
                </div>
                
                <button id="nextBtn" class="btn" style="margin-top:15px; opacity:0.5; pointer-events:none;" onclick="nextStep()">Continue &rarr;</button>
            </div>
        </div>

        
<div id="view-result" class="view">
            <div class="glass-panel result-card">
                <div class="result-header">Your Digital Mentor Says:</div>
                <div class="result-archetype" id="resArchetype">Loading...</div>
                
                
<div class="typewriter-text" id="resBody"><span class="cursor"></span></div>
                
                <div class="action-box hidden" id="resActionBox">
                    <strong style="color:var(--primary); display:block; margin-bottom:5px;">‚ö° TINY NEXT STEP:</strong>
                    <span id="resAction" style="font-size:1.1rem; font-weight:600; color:white;">Action...</span>
                </div>
                
                <div class="hidden" id="resButtons" style="display:flex; flex-direction:column; gap:10px;">
                    <button class="btn" onclick="saveResult()">Save this Spark üíæ</button>
                    <button class="btn btn-secondary" onclick="goHome()">Back to Modes</button>
                </div>
            </div>
        </div>

        
<div id="view-saved" class="view">
            <div class="top-nav">
                <button onclick="goHome()" class="icon-btn">‚Üê</button>
                <h3 style="margin:0;">Your Spark Library</h3>
                <div style="width:40px;"></div>
            </div>
            <div id="savedList" style="padding-bottom:50px;"></div>
        </div>

        
<footer class="footer-bar">
            <button class="story-btn" onclick="openStory()">Read the Origin Story üìñ</button>
            
            
<a href="https://ekolitika.framer.website/" target="_blank" class="story-btn">
                With üíö for the creative community, made by EKOLiTiKA
            </a>
        </footer>

    </div>

    
<div class="modal-overlay" id="storyModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0; font-size:1.5rem; color:var(--primary);">Born from Struggle</h3>
                <button onclick="closeStory()" class="icon-btn">‚úï</button>
            </div>
            
            <div class="story-text">
                In 2025, a team joined <a href="https://ekolitika.framer.website/project/the-creative-mess" target="_blank" class="story-highlight" style="text-decoration: underline;">The Creative Mess</a>‚Äîan Erasmus+ course that proved creativity isn't magic. It's a cycle: brainstorm, organize, rest, inspire, experiment, repeat.
            </div>
            <div class="story-text">
                The problem? Most tools feed you empty motivation or treat creativity like a factory line. Neither helps when you're actually stuck.
            </div>
            <div class="story-text">
                So we built <span class="story-highlight">Creative Pulse</span>. A free tool that diagnoses your block, tells you what you actually need, and gives you real feedback‚Äînot fluff.
            </div>
            <div class="story-text">
                From stuck to unstuck. Idea to action. Exhaustion to rhythm.
            </div>
            <div style="margin-top:30px; padding-top:20px; border-top:1px solid var(--glass-border); text-align:center; font-size:0.9rem; color:#cbd5e1;">
                Built by <b>EKOLiTiKA</b> ‚Äî an NGO learning sustainability from nature and applying circular thinking to creativity.
            </div>
            <button class="btn" style="margin-top:20px;" onclick="closeStory()">Got it!</button>
        </div>
    </div>

<script>
/* --- DATA & CONTENT --- */
const content = {
    diagnose: {
        steps: [
            { q: "Right now, how does your creative block feel?", type:"choice", opts: ["Foggy & Overwhelming", "Empty & Drained", "Anxious & Fast", "Boring & Repetitive"] },
            { q: "What is the story you are telling yourself?", type:"choice", opts: ["'I'm not good enough'", "'I'm out of time'", "'This idea is stupid'", "'I'm don't know where to start'"] },
            { q: "Describe the specific project or problem in one sentence:", type:"text" }
        ]
    },
    inspire: {
        steps: [
            { q: "What kind of fuel do you need?", type:"choice", opts: ["Soft comfort (Rest)", "Hard truth (Kick)", "New input (Awe)", "Just a distraction"] },
            { q: "Who is an artist or creator you are jealous of right now?", type:"text" },
            { q: "If you couldn't fail, what would you make today?", type:"text" }
        ]
    },
    brainstorm: {
        steps: [
            { q: "Pick a constraint to force creativity:", type:"choice", opts: ["Explain it to a 5-year-old", "Do it with $0 budget", "Make the 'evil' version", "Finish it in 15 minutes"] },
            { q: "What is the core problem you want to solve?", type:"text" },
            { q: "Write down 3 terrible, silly, or illegal ideas. Go.", type:"text" }
        ]
    },
    organize: {
        steps: [
            { q: "How many tabs/tasks are open in your brain?", type:"choice", opts: ["1-3 (Clean)", "4-10 (Cluttered)", "10+ (Disaster)", "System overload"] },
            { q: "Which single task is making you feeling guilty?", type:"text" },
            { q: "What is the absolute smallest first step?", type:"text" }
        ]
    },
    experiment: {
        steps: [
            { q: "How risky does this feel?", type:"choice", opts: ["Terrifying", "Uncomfortable", "Exciting", "Safe"] },
            { q: "What is the worst REALISTIC outcome?", type:"text" },
            { q: "How will you celebrate just for trying?", type:"text" }
        ]
    }
};

/* --- STATE --- */
let state = {
    user: { name: "", field: "" },
    currentMode: null,
    step: 0,
    answers: []
};


/* --- VIEW MANAGEMENT --- */
function setView(viewId) {
    // 1. Remove 'active' from all views
    document.querySelectorAll('.view').forEach(view => {
        view.classList.remove('active');
    });
    // 2. Add 'active' to the target view. This is where the error occurred
    // because document.getElementById(viewId) was sometimes null. 
    // Now that all JS is in one block, this should resolve the issue.
    const targetView = document.getElementById(viewId);
    if (targetView) {
        targetView.classList.add('active');
    } else {
        console.error(`Error: View element with ID "${viewId}" not found in the DOM.`);
    }
}

function goHome() {
    state.currentMode = null;
    state.step = 0;
    state.answers = [];
    document.getElementById('optionsArea').innerHTML = '';
    document.getElementById('textInput').value = '';
    document.getElementById('textInput').classList.add('hidden');
    
    // Ensure the dashboard name is current
    document.getElementById('dashName').textContent = state.user.name;
    
    setView('dashboard');
}

/* --- ONBOARDING & AUTH --- */
function onboardUser() {
    const nameInput = document.getElementById('userName').value.trim();
    const fieldInput = document.getElementById('userField').value.trim();
    
    if (nameInput && fieldInput) {
        state.user.name = nameInput;
        state.user.field = fieldInput;
        localStorage.setItem('cp_user', JSON.stringify(state.user));
        document.getElementById('dashName').textContent = state.user.name;
        setView('dashboard');
    } else {
        // Use a small temporary message box instead of alert()
        const onboardForm = document.getElementById('onboardForm');
        const messageBox = document.createElement('p');
        messageBox.textContent = "Please enter your name and creative field to start!";
        messageBox.style.color = 'var(--secondary)';
        messageBox.style.fontWeight = '700';
        messageBox.style.marginTop = '-10px';
        onboardForm.prepend(messageBox);
        setTimeout(() => messageBox.remove(), 2500);
    }
}

function logout() {
    // Custom modal instead of alert/confirm
    const modal = document.getElementById('storyModal');
    document.querySelector('#storyModal .modal-content h3').textContent = 'Confirm Reset';
    document.querySelector('#storyModal .story-text').innerHTML = `Are you sure you want to reset your profile? You will lose your saved Sparks (locally stored) and return to the onboarding screen.`;
    document.querySelector('#storyModal .story-text').style.color = 'white';
    document.querySelector('#storyModal .story-text').style.fontWeight = '700';
    document.querySelector('#storyModal .modal-content .btn').textContent = 'Yes, Reset';
    document.querySelector('#storyModal .modal-content .btn').onclick = () => {
        localStorage.removeItem('cp_user');
        localStorage.removeItem('cp_sparks');
        state.user = { name: "", field: "" };
        closeStory(); 
        goHome(); 
        setView('onboarding');
    };
    
    modal.classList.add('open');
}


/* --- WIZARD LOGIC --- */
function startMode(mode) {
    state.currentMode = mode;
    state.step = 0;
    state.answers = [];
    document.getElementById('wizardModeTitle').textContent = mode.toUpperCase();
    document.getElementById('nextBtn').style.opacity = '0.5';
    document.getElementById('nextBtn').style.pointerEvents = 'none';
    setView('wizard');
    displayQuestion();
}

function displayQuestion() {
    const mode = state.currentMode;
    const step = state.step;
    const totalSteps = content[mode].steps.length;
    const currentQ = content[mode].steps[step];
    
    // Update Progress Bar
    const progress = ((step + 1) / totalSteps) * 100;
    document.getElementById('progressBar').style.width = `${progress}%`;

    // Update Question Text
    document.getElementById('questionText').textContent = currentQ.q;
    
    // Handle Input Type
    const optionsArea = document.getElementById('optionsArea');
    const textInput = document.getElementById('textInput');
    
    optionsArea.innerHTML = '';
    textInput.classList.add('hidden');
    textInput.value = '';

    document.getElementById('nextBtn').style.opacity = '0.5';
    document.getElementById('nextBtn').style.pointerEvents = 'none';

    if (currentQ.type === 'choice') {
        currentQ.opts.forEach(option => {
            const btn = document.createElement('button');
            btn.classList.add('option-btn');
            btn.textContent = option;
            btn.onclick = () => selectOption(btn, option);
            optionsArea.appendChild(btn);
        });
    } else if (currentQ.type === 'text') {
        textInput.classList.remove('hidden');
        textInput.oninput = checkTextInput;
    }
}

function selectOption(selectedBtn, answer) {
    document.querySelectorAll('.option-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    selectedBtn.classList.add('selected');
    state.answers[state.step] = answer;
    
    document.getElementById('nextBtn').style.opacity = '1';
    document.getElementById('nextBtn').style.pointerEvents = 'all';
}

function checkTextInput() {
    const textInput = document.getElementById('textInput');
    if (textInput.value.trim().length > 10) {
        state.answers[state.step] = textInput.value.trim();
        document.getElementById('nextBtn').style.opacity = '1';
        document.getElementById('nextBtn').style.pointerEvents = 'all';
    } else {
        document.getElementById('nextBtn').style.opacity = '0.5';
        document.getElementById('nextBtn').style.pointerEvents = 'none';
    }
}


function nextStep() {
    const mode = state.currentMode;
    const totalSteps = content[mode].steps.length;

    // Save answer from text input if applicable
    if (content[mode].steps[state.step].type === 'text') {
        checkTextInput();
    }
    
    // Ensure an answer was selected/entered
    if (typeof state.answers[state.step] === 'undefined' || state.answers[state.step] === '') {
         // Use a small temporary message box instead of alert()
        const questionText = document.getElementById('questionText');
        questionText.style.color = '#ff6b6b';
        setTimeout(() => {
            questionText.style.color = '#fff';
        }, 1000);
        return; 
    }
    
    state.step++;
    
    if (state.step < totalSteps) {
        displayQuestion();
    } else {
        showResult();
    }
}

/* --- RESULT LOGIC --- */

// Simplified text generation based on the state for demonstration purposes
// In a real application, this is where you would call the Gemini API
function generateAdvice() {
    const mode = state.currentMode;
    const ans = state.answers;
    
    let archetype = "The Alchemist";
    let body = "You have completed the Creative Pulse ritual. Your current answers indicate that you are ready for a powerful change. The following advice is generated based on your inputs.";
    let action = "Find a quiet space and write down 5 things you love about your current project, no matter how small.";

    if (mode === 'diagnose') {
        if (ans[0] === "Foggy & Overwhelming") {
            archetype = "The Navigator";
            body = "Your biggest block is mental clutter. You aren't out of ideas, you have too many‚Äîor too many steps. This leads to decision paralysis. Focus on eliminating choices, not creating new ones. A simple framework will cut through the fog.";
            action = "Write down every single task related to the project, no matter how tiny, and number them 1 to N. Only do step 1.";
        } else if (ans[0] === "Empty & Drained") {
            archetype = "The Wellspring";
            body = "You are suffering from creative exhaustion. This is not a failure of will, but a sign that your input/output balance is off. You need deep rest and non-work-related input, like consuming media or nature. 'I'm not good enough' is the voice of fatigue.";
            action = "Take a full 48-hour break from the project. Watch a movie, take a hike, or read a book that has nothing to do with your field.";
        } else if (ans[0] === "Anxious & Fast") {
            archetype = "The Regulator";
            body = "Your block is anxiety, likely stemming from a deadline (real or self-imposed). This speed makes your work shallow. You need constraints to slow down and create quality. You are rushing to finish, not to create well. 'I'm out of time' is a destructive mantra.";
            action = "Set a 30-minute timer. For the first 15 minutes, do nothing but analyze a piece of work you admire. For the next 15, apply only one element of that analysis to your project.";
        } else if (ans[0] === "Boring & Repetitive") {
            archetype = "The Provocateur";
            body = "The problem is predictability. You are stuck in a rut because you are following rules that no longer serve you. You need a shock to the system, a wild detour, or a total rule-break. Embrace novelty over safety.";
            action = "Find a piece of art or music that you hate. Spend 1 hour trying to understand why someone might love it. Inject one element of that 'hated' aesthetic into your project.";
        }
    } else if (mode === 'inspire') {
        archetype = "The Muse Seeker";
        body = `You asked for ${ans[0].toLowerCase()} fuel, which suggests you need to re-engage your curiosity. Since you admire/are jealous of ${ans[1]}, let's dig into that. True inspiration comes from integrating others' work, not copying it.`;
        action = `Analyze the favorite piece of work from ${ans[1]}. Identify its three core rules (color, tempo, form). Break one of those rules in your own work.`;
    } else if (mode === 'brainstorm') {
        archetype = "The Idea Machine";
        body = `You chose the ${ans[0].toLowerCase()} constraint to force novelty, and you identified the core problem as: "${ans[1]}". Now, we must use your three terrible ideas to reveal one truly good one. Terrible ideas are the soil for genius.`;
        action = `Take the one 'terrible' idea that made you cringe the most. Flip its premise completely. (Example: If the terrible idea was 'Use only red', the flipped idea is 'Use no red'). That's your next step.`;
    } else if (mode === 'organize') {
        archetype = "The Architect";
        body = `With your current task load (${ans[0]}), it's no surprise you feel guilty about: "${ans[1]}". Guilt is often a sign of complexity, not procrastination. The solution is simplicity and visible progress.`;
        action = `Your smallest step is: "${ans[2]}". Do only that step right now. Do not check your email, do not look at social media. When it is done, you are done for the day.`;
    } else if (mode === 'experiment') {
        archetype = "The Risk Taker";
        body = `You feel the risk is ${ans[0].toLowerCase()}, but you've accepted the worst realistic outcome is: "${ans[1]}". The true block is fear of the unknown, not the risk itself. You have to externalize the experiment so it's not a 'failure,' but a 'test'.`;
        action = `Go perform the experiment, but rename it 'Version 0.1'. Tell someone you trust that you are trying a test and that the goal is simply to collect data, not succeed.`;
    }
    
    return { archetype, body, action };
}

function typeWriter(text, elementId, callback) {
    const element = document.getElementById(elementId);
    let i = 0;
    
    // Clear previous content and add cursor span
    element.innerHTML = '<span class="cursor"></span>';
    const cursor = element.querySelector('.cursor');

    function typing() {
        if (i < text.length) {
            cursor.before(text.charAt(i));
            i++;
            setTimeout(typing, 30); // Typing speed
        } else {
            cursor.remove(); // Remove cursor when typing is done
            if (callback) {
                callback();
            }
        }
    }
    typing();
}

function showResult() {
    const { archetype, body, action } = generateAdvice();
    
    document.getElementById('resArchetype').textContent = archetype;
    document.getElementById('resAction').textContent = action;
    
    document.getElementById('resBody').innerHTML = '';
    document.getElementById('resActionBox').classList.add('hidden');
    document.getElementById('resButtons').classList.add('hidden');
    
    setView('result');
    
    // Animate advice body text
    typeWriter(body, 'resBody', () => {
        // Show action box and buttons after typing finishes
        document.getElementById('resActionBox').classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('resButtons').classList.remove('hidden');
            document.getElementById('resButtons').style.display = 'flex';
        }, 500); // Slight delay for the buttons to appear
    });
}

/* --- SAVE SPARK LOGIC (LocalStorage) --- */
function getSparks() {
    const sparksJson = localStorage.getItem('cp_sparks');
    return sparksJson ? JSON.parse(sparksJson) : [];
}

function saveSparks(sparks) {
    localStorage.setItem('cp_sparks', JSON.stringify(sparks));
}

function saveResult() {
    const { archetype, body, action } = generateAdvice(); // Regenerate advice from current state
    const sparks = getSparks();
    
    const newSpark = {
        id: Date.now(),
        mode: state.currentMode.charAt(0).toUpperCase() + state.currentMode.slice(1),
        archetype: archetype,
        advice: body,
        action: action,
        date: new Date().toLocaleDateString()
    };
    
    sparks.unshift(newSpark); // Add to the front
    saveSparks(sparks);
    
    // Change button text to confirm save
    const saveBtn = document.querySelector('#resButtons .btn:first-child');
    saveBtn.textContent = 'Spark Saved! ‚úÖ';
    saveBtn.disabled = true;
    setTimeout(() => {
        saveBtn.textContent = 'Save this Spark üíæ';
        saveBtn.disabled = false;
    }, 2000);
}

function showSaved() {
    setView('saved');
    const sparks = getSparks();
    const list = document.getElementById('savedList');
    list.innerHTML = '';

    if (sparks.length === 0) {
        list.innerHTML = '<div class="glass-panel" style="text-align:center;"><p style="color:var(--text-muted);">You haven\'t saved any Sparks yet! Use one of the modes to find advice.</p></div>';
        return;
    }
    
    sparks.forEach(spark => {
        const item = document.createElement('div');
        item.classList.add('spark-item');
        item.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span style="font-weight:700; color:var(--primary); font-size:1.1rem;">${spark.archetype} (${spark.mode})</span>
                <span style="font-size:0.8rem; color:var(--text-muted);">${spark.date}</span>
            </div>
            <p style="font-size:0.9rem; line-height:1.5; color:#cbd5e1; margin-bottom:15px;">${spark.advice}</p>
            <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; font-weight:600; font-size:0.95rem;">
                ‚ö° ACTION: ${spark.action}
            </div>
        `;
        list.appendChild(item);
    });
}

/* --- MODAL LOGIC --- */
function openStory() {
    const modal = document.getElementById('storyModal');
    // Reset modal content for the actual story
    document.querySelector('#storyModal .modal-content h3').textContent = 'Born from Struggle';
    document.querySelector('#storyModal .story-text').innerHTML = `
        In 2025, a team joined <a href="https://ekolitika.framer.website/project/the-creative-mess" target="_blank" class="story-highlight" style="text-decoration: underline;">The Creative Mess</a>‚Äîan Erasmus+ course that proved creativity isn't magic. It's a cycle: brainstorm, organize, rest, inspire, experiment, repeat.
        The problem? Most tools feed you empty motivation or treat creativity like a factory line. Neither helps when you're actually stuck.
        So we built <span class="story-highlight">Creative Pulse</span>. A free tool that diagnoses your block, tells you what you actually need, and gives you real feedback‚Äînot fluff.
        From stuck to unstuck. Idea to action. Exhaustion to rhythm.
    `;
    document.querySelector('#storyModal .story-text').style.color = '';
    document.querySelector('#storyModal .story-text').style.fontWeight = '';
    document.querySelector('#storyModal .modal-content .btn').textContent = 'Got it!';
    document.querySelector('#storyModal .modal-content .btn').onclick = closeStory;
    modal.classList.add('open');
}

function closeStory() {
    document.getElementById('storyModal').classList.remove('open');
}

/* --- INIT --- */
window.onload = () => {
    const savedUser = localStorage.getItem('cp_user');
    if (savedUser) {
        state.user = JSON.parse(savedUser);
        // setView is now guaranteed to be defined
        setView('dashboard'); 
        const dashNameElement = document.getElementById('dashName');
        if (dashNameElement) {
            dashNameElement.textContent = state.user.name;
        } else {
             console.error("Dashboard name element not found.");
        }
    } else {
        setView('onboarding');
    }
    
    // Setup event listeners
    const onboardForm = document.getElementById('onboardForm');
    if (onboardForm) {
        onboardForm.addEventListener('submit', (e) => {
            e.preventDefault();
            onboardUser();
        });
    } else {
        console.error("Onboarding form element not found.");
    }
};

</script>
