<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Creative Pulse</title>
    <style>
        /* --- FONTS & VARS --- */
        @import url('https://fonts.googleapis.com/css2?family=Caprasimo&family=Inter:wght@300;400;600;800&display=swap');

        :root {
            --primary: #a855f7;
            --primary-glow: #a855f788;
            --secondary: #ec4899;
            --bg-dark: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            
            /* Dynamic Theme Variables */
            --orb-1-color: #a855f7;
            --orb-2-color: #ec4899;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: #0f172a;
            color: var(--text-main);
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background 1s ease;
        }

        /* --- DYNAMIC THEMES (Biofeedback) --- */
        /* Rest/Comfort Theme (Green/Teal) */
        body.theme-rest { --orb-1-color: #10b981; --orb-2-color: #0ea5e9; }
        /* Kick/Hard Truth Theme (Red/Orange) */
        body.theme-kick { --orb-1-color: #ef4444; --orb-2-color: #f59e0b; }
        /* Weird/Experiment Theme (Gold/Purple) */
        body.theme-weird { --orb-1-color: #fbbf24; --orb-2-color: #8b5cf6; }

        /* --- ANIMATED BACKGROUND --- */
        .ambient-light {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #0f172a 100%);
            transition: background 1s ease;
        }
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s infinite ease-in-out;
            transition: background 1.5s ease; /* Smooth color transition */
        }
        /* Mobile Fix: Use vw instead of px to prevent overflow */
        .orb-1 { width: 60vw; height: 60vw; background: var(--orb-1-color); top: -10%; left: -10%; animation-delay: 0s; }
        .orb-2 { width: 70vw; height: 70vw; background: var(--orb-2-color); bottom: -10%; right: -10%; animation-delay: -5s; }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(30px, -30px); }
        }

        /* --- UI LAYOUT --- */
        .container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            z-index: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            position: relative;
        }

        /* --- HEADER --- */
        .header {
            text-align: center;
            margin-top: 15px;
            display: flex; flex-direction: column; align-items: center;
        }
        
        .logo-img {
            width: 160px; height: auto;
            filter: brightness(1.2); 
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .logo-img:hover { transform: scale(1.05) rotate(-2deg); }
        
        .platform-title {
            font-family: 'Caprasimo', cursive;
            font-size: 3rem; 
            font-weight: 800;
            margin-top: 10px; margin-bottom: 25px;
            color: #1e1b4b; 
            letter-spacing: 1.5px;
            text-shadow: 
                0 0 10px rgba(255, 255, 255, 0.8),
                0 0 25px rgba(255, 255, 255, 0.6),
                0 0 45px rgba(255, 255, 255, 0.4);
        }

        /* --- GLASS CARDS --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 28px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            transition: transform 0.2s ease;
            position: relative; overflow: hidden;
        }

        /* --- BUTTONS --- */
        .btn {
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            color: white; border: none;
            padding: 16px 32px; border-radius: 16px;
            font-size: 1rem; font-weight: 700;
            cursor: pointer; width: 100%;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
            text-decoration: none;
        }
        .btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 25px rgba(168, 85, 247, 0.5); }
        .btn:active { transform: scale(0.96); }
        
        .btn-secondary { background: rgba(255,255,255,0.1); box-shadow: none; border: 1px solid rgba(255,255,255,0.1); }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }

        .icon-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            width: 40px; height: 40px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
            font-size: 1.2rem;
        }
        .icon-btn:hover { background: rgba(236, 72, 153, 0.2); color: white; border-color: #ec4899; transform: rotate(10deg); }

        .story-btn {
            background: rgba(255, 255, 255, 0.15); 
            border: 1px solid var(--glass-border);
            color: #fff; font-size: 0.85rem; font-weight: 600;
            cursor: pointer; padding: 10px 15px;
            border-radius: 12px; transition: all 0.3s;
            text-decoration: none; display: inline-block; white-space: nowrap;
        }
        .story-btn:hover { background: rgba(168, 85, 247, 0.2); transform: translateY(-2px); border-color: var(--primary); }

        /* --- DASHBOARD GRID --- */
        .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .mode-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.07), rgba(255,255,255,0.02));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            min-height: 145px;
        }
        .mode-card:hover { 
            background: rgba(255,255,255,0.12); 
            transform: translateY(-5px) scale(1.02); 
            border-color: var(--primary);
            box-shadow: 0 10px 30px -10px rgba(168, 85, 247, 0.4);
        }
        /* Special Style for the Jolts Card */
        .card-jolt { border-color: rgba(236, 72, 153, 0.4); }
        .card-jolt:hover { box-shadow: 0 10px 30px -10px rgba(236, 72, 153, 0.4); border-color: var(--secondary); }

        .mode-emoji { font-size: 2.8rem; margin-bottom: 12px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
        .mode-name { font-weight: 800; color: white; margin-bottom: 5px; font-size: 1.1rem; }
        .mode-desc { font-size: 0.75rem; color: #cbd5e1; line-height: 1.4; max-width: 90%; }

        /* --- WIZARD & INPUTS --- */
        .progress-container { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 30px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 10px; width: 0%; transition: width 0.5s; }
        
        .question-text { font-size: 1.5rem; font-weight: 800; margin-bottom: 25px; line-height: 1.35; color: #fff; }
        
        .option-btn {
            display: flex; align-items: center; width: 100%; text-align: left;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--glass-border);
            padding: 18px 22px; margin-bottom: 12px;
            border-radius: 16px; color: #cbd5e1;
            cursor: pointer; transition: 0.2s;
            font-size: 1rem; font-weight: 500;
        }
        .option-btn:hover { background: rgba(168, 85, 247, 0.15); border-color: var(--primary); color: white; padding-left: 26px; }
        .option-btn.selected { background: linear-gradient(90deg, var(--primary), #9333ea); border-color: var(--primary); color: white; font-weight: 700; transform: scale(1.01); }

        input[type="text"], textarea {
            width: 100%; background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            padding: 16px; border-radius: 14px;
            color: white; font-size: 1rem; margin-bottom: 18px;
            outline: none; transition: 0.2s; font-family: inherit;
        }
        input[type="text"]:focus, textarea:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); }
        
        /* The "Burn" Animation for Negative Thoughts */
        @keyframes burn {
            0% { opacity: 1; transform: scale(1); filter: contrast(1); }
            50% { opacity: 0.8; transform: scale(1.05) skewX(10deg); filter: contrast(2) brightness(2); color: #fb923c; }
            100% { opacity: 0; transform: scale(1.1) translateY(-20px); filter: blur(10px); }
        }
        .burning { animation: burn 0.8s forwards; pointer-events: none; }

        /* --- RESULTS --- */
        .result-card { border-top: 5px solid var(--primary); }
        .result-header { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 2px; color: var(--secondary); margin-bottom: 15px; font-weight: 800; }
        .result-archetype { font-size: 2rem; font-weight: 900; margin-bottom: 20px; background: linear-gradient(135deg, #fff, #e9d5ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .typewriter-text { font-size: 1.15rem; line-height: 1.7; color: #e2e8f0; margin-bottom: 30px; border-left: 2px solid var(--glass-border); padding-left: 15px; }
        .cursor::after { content: '|'; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        
        .action-box { background: rgba(168, 85, 247, 0.15); border: 1px solid rgba(168, 85, 247, 0.3); padding: 20px; border-radius: 16px; margin-bottom: 25px; }

        /* --- VIEWS UTILITY --- */
        .view { display: none; animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }

        /* --- FOOTER & NAV --- */
        .footer-bar {
            display: flex; justify-content: center; gap: 20px; align-items: center;
            width: 100%; padding: 20px; margin-top: auto;
        }
        .top-nav { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 100; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal-content {
            background: #1e1b4b; border: 2px solid var(--primary);
            width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto;
            border-radius: 24px; padding: 30px;
            transform: translateY(20px); transition: 0.3s;
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.4);
        }
        .modal-overlay.open .modal-content { transform: translateY(0); }
        
        /* --- SAVED SPARKS --- */
        .spark-item { padding: 20px; background: rgba(0,0,0,0.25); border-radius: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; cursor: pointer; }
        .spark-item:hover { border-color: var(--primary-glow); background: rgba(0,0,0,0.4); transform: translateX(5px); }

    </style>
</head>
<body>

    <div class="ambient-light">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <div class="container">
        
        <header class="header">
            <a href="https://ekolitika.framer.website/" target="_blank">
                <img src="https://framerusercontent.com/images/NhZAoGoxBJzZIPWRIXCzVkkNuDA.png?scale-down-to=512" alt="EKOLITIKA Logo" class="logo-img">
            </a>
            <div class="platform-title">Creative Pulse</div>
        </header>

        <div id="view-onboarding" class="view active">
            <div class="glass-panel" style="text-align:center;">
                <h2 style="font-size:1.8rem; margin-bottom:15px; background: linear-gradient(to right, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Unstick your mind.</h2>
                <p style="color:#cbd5e1; margin-bottom:30px; line-height:1.6;">
                    A digital mentor for the creative community.<br>
                    Diagnose blocks, find inspiration, and get actionable advice.
                </p>
                <form id="onboardForm" style="text-align:left;">
                    <label style="display:block; margin-bottom:8px; font-weight:600; color:#e9d5ff;">Your Name / Nickname</label>
                    <input type="text" id="userName" placeholder="e.g. Alex, Sam..." required autocomplete="off">
                    
                    <button type="submit" class="btn">Start Your Journey üöÄ</button>
                </form>
            </div>
        </div>

        <div id="view-dashboard" class="view">
            <div class="top-nav">
                <div>
                    <div style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;">Welcome back</div>
                    <div style="font-size:1.4rem; font-weight:700;" id="dashName">Creator</div>
                </div>
                <button onclick="app.logout()" class="icon-btn" title="Reset Profile">‚èª</button>
            </div>

            <div class="glass-panel" style="padding:20px 20px 30px 20px;">
                <div style="text-align:center; margin-bottom:20px; font-weight:600; color:#e2e8f0;">Choose your mode</div>
                <div class="mode-grid">
                    <div class="mode-card" onclick="app.startMode('diagnose')">
                        <div class="mode-emoji">ü©∫</div>
                        <div class="mode-name">Diagnose</div>
                        <div class="mode-desc">Identify exactly why you are stuck.</div>
                    </div>
                    <div class="mode-card" onclick="app.startMode('inspire')">
                        <div class="mode-emoji">‚ú®</div>
                        <div class="mode-name">Inspire</div>
                        <div class="mode-desc">Refuel your creative energy tank.</div>
                    </div>
                    <div class="mode-card" onclick="app.startMode('brainstorm')">
                        <div class="mode-emoji">üí°</div>
                        <div class="mode-name">Brainstorm</div>
                        <div class="mode-desc">Break rules and think wild.</div>
                    </div>
                    <div class="mode-card" onclick="app.startMode('organize')">
                        <div class="mode-emoji">üì¶</div>
                        <div class="mode-name">Organize</div>
                        <div class="mode-desc">Turn chaos into tiny steps.</div>
                    </div>
                    
                    <div class="mode-card card-jolt" onclick="app.triggerJolt()">
                        <div class="mode-emoji">‚ö°</div>
                        <div class="mode-name">Jolts</div>
                        <div class="mode-desc">Instant oblique strategies.</div>
                    </div>

                    <div class="mode-card" style="border-style:dashed; opacity:0.8;" onclick="app.showSaved()">
                        <div class="mode-emoji">üìö</div>
                        <div class="mode-name">Library</div>
                        <div class="mode-desc">Your saved sparks.</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-wizard" class="view">
            <div class="top-nav">
                <button onclick="app.goHome()" class="icon-btn" title="Exit">‚úï</button>
                <div style="font-weight:700; color:var(--primary);" id="wizardModeTitle">MODE</div>
                <div style="width:40px;"></div> 
            </div>

            <div class="glass-panel">
                <div class="progress-container"><div class="progress-fill" id="progressBar"></div></div>
                
                <div id="questionContainer">
                    <div id="questionText" class="question-text">Question goes here...</div>
                    <div id="optionsArea"></div>
                    <div id="textInputContainer"> 
                        <textarea id="textInput" class="hidden" rows="3" placeholder="Type your thoughts here..."></textarea>
                    </div>
                </div>
                
                <button id="nextBtn" class="btn" style="margin-top:15px; opacity:0.5; pointer-events:none;" onclick="app.nextStep()">Continue &rarr;</button>
            </div>
        </div>

        <div id="view-result" class="view">
            <div class="glass-panel result-card">
                <div class="result-header">Your Digital Mentor Says:</div>
                <div class="result-archetype" id="resArchetype">Loading...</div>
                
                <div class="typewriter-text" id="resBody"><span class="cursor"></span></div>
                
                <div class="action-box hidden" id="resActionBox">
                    <strong style="color:var(--primary); display:block; margin-bottom:5px;">‚ö° TINY NEXT STEP:</strong>
                    <span id="resAction" style="font-size:1.1rem; font-weight:600; color:white;">Action...</span>
                </div>
                
                <div class="hidden" id="resButtons" style="display:flex; flex-direction:column; gap:10px;">
                    <button class="btn" onclick="app.saveResult()">Save this Spark üíæ</button>
                    <button class="btn btn-secondary" onclick="app.goHome()">Back to Modes</button>
                </div>
            </div>
        </div>

        <div id="view-saved" class="view">
            <div class="top-nav">
                <button onclick="app.goHome()" class="icon-btn">‚Üê</button>
                <h3 style="margin:0;">Your Spark Library</h3>
                <div style="width:40px;"></div>
            </div>
            <div id="savedList" style="padding-bottom:50px;"></div>
        </div>

        <footer class="footer-bar">
            <button class="story-btn" onclick="app.openStory()">Read the Origin Story üìñ</button>
        </footer>

    </div>

    <div class="modal-overlay" id="genericModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 id="modalTitle" style="margin:0; font-size:1.5rem; color:var(--primary);">Title</h3>
                <button onclick="app.closeModal()" class="icon-btn">‚úï</button>
            </div>
            <div id="modalBody" style="margin-bottom: 20px;"></div>
            <button class="btn" onclick="app.closeModal()">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, query, orderBy, limit, onSnapshot, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /* --- FIREBASE CONFIGURATION ---
           To enable Cloud Syncing, paste your config object inside the brackets below.
           If you leave this empty, the app will work in "Offline Mode" (saving to browser only).
        */
        const firebaseConfig = {
            // Paste your keys here like: apiKey: "AIzaSy...",
        };

        // --- DATA LAYER (Offline First Architecture) ---
        const DataStore = {
            db: null,
            auth: null,
            userId: null,
            isOnline: false,

            init: async function() {
                // 1. Try to connect to Firebase if config exists
                if (Object.keys(firebaseConfig).length > 0) {
                    try {
                        const fbApp = initializeApp(firebaseConfig);
                        this.db = getFirestore(fbApp);
                        this.auth = getAuth(fbApp);
                        
                        // Try to enable offline persistence for Firestore
                        try { await enableIndexedDbPersistence(this.db); } catch (err) { console.log("Persistence fallback"); }

                        // Auth Listener
                        onAuthStateChanged(this.auth, (user) => {
                            if (user) {
                                this.userId = user.uid;
                                this.isOnline = true;
                                this.syncSparks(); // Start listening for cloud updates
                            } else {
                                signInAnonymously(this.auth).catch(e => console.log("Auth failed, using offline mode"));
                            }
                        });
                    } catch (e) {
                        console.log("Firebase Init Failed (Offline Mode Active):", e);
                    }
                } else {
                    console.log("No Config Found. Running in Offline Mode.");
                }
            },

            // Save a spark (Tries Cloud + Local)
            saveSpark: async function(sparkData) {
                // 1. Always save to LocalStorage (Instant)
                const localData = JSON.parse(localStorage.getItem('savedSparks') || '[]');
                const newSpark = { ...sparkData, id: 'local_' + Date.now(), timestamp: new Date().toISOString() };
                localData.unshift(newSpark);
                localStorage.setItem('savedSparks', JSON.stringify(localData));

                // 2. Try Cloud Save (Background)
                if (this.isOnline && this.userId && this.db) {
                    try {
                        await addDoc(collection(this.db, `users/${this.userId}/sparks`), {
                            ...sparkData,
                            timestamp: new Date().toISOString()
                        });
                    } catch (e) {
                        console.error("Cloud save failed (data is safe locally)", e);
                    }
                }
                return true; // Always return true because local save succeeded
            },

            // Get Sparks (Merges Local & Cloud)
            getSparks: function(callback) {
                // 1. Load Local Immediately
                const localData = JSON.parse(localStorage.getItem('savedSparks') || '[]');
                callback(localData);

                // 2. Listen for Cloud Updates
                if (this.isOnline && this.userId && this.db) {
                    const q = query(collection(this.db, `users/${this.userId}/sparks`), orderBy("timestamp", "desc"), limit(20));
                    onSnapshot(q, (snapshot) => {
                        const cloudSparks = [];
                        snapshot.forEach(doc => cloudSparks.push({ id: doc.id, ...doc.data() }));
                        // Update UI with Cloud Data (it overrides local if successful)
                        if(cloudSparks.length > 0) callback(cloudSparks);
                    }, (err) => console.log("Cloud sync error", err));
                }
            }
        };

        // Initialize Data Layer
        DataStore.init();

        /* --- CONTENT & LOGIC --- */
        const content = {
            diagnose: {
                steps: [
                    { q: "Right now, how does your creative block feel?", type:"choice", opts: ["Foggy & Overwhelming", "Empty & Drained", "Anxious & Fast", "Boring & Repetitive"] },
                    { q: "What is the story you are telling yourself?", type:"choice", opts: ["'I'm not good enough'", "'I'm out of time'", "'This idea is stupid'", "'I don't know where to start'"] }, // Grammar Fixed
                    { q: "Describe the specific project or problem in one sentence:", type:"text", burn: true } // Burn enabled
                ],
                archetypes: {
                    "Foggy & Overwhelming": {
                        archetype: "The Overwhelmed Navigator",
                        advice: "Your issue is structural. You have too many open loops. You need to narrow your focus and create strict boundaries.",
                        action: "Pick one (and only one) task to complete today. Ignore the rest.",
                        theme: "theme-rest"
                    },
                    "Empty & Drained": {
                        archetype: "The Burnt-Out Well",
                        advice: "Your well is dry. This is not a productivity problem; it's a depletion problem. You need genuine input and rest.",
                        action: "Schedule 30 minutes of non-productive, non-screen time today.",
                        theme: "theme-rest"
                    },
                    "Anxious & Fast": {
                        archetype: "The Perfectionist Paralytic",
                        advice: "The gap between your taste and your ability is causing anxiety. You need to create an ugly first draft, fast.",
                        action: "Set a 10-minute timer and produce the worst possible version of your work.",
                        theme: "theme-kick"
                    },
                    "Boring & Repetitive": {
                        archetype: "The Stale Routine",
                        advice: "Your process has become mechanical. You need to introduce a new constraint or a foreign input to disrupt patterns.",
                        action: "Change your environment. Work from a different room or cafe for one hour.",
                        theme: "theme-weird"
                    }
                }
            },
            inspire: {
                 steps: [
                    { q: "What kind of fuel do you need?", type:"choice", opts: ["Soft comfort (Rest)", "Hard truth (Kick)", "New input (Awe)", "Just a distraction"] },
                    { q: "Who is an artist or creator you are jealous of right now?", type:"text" },
                    { q: "If you couldn't fail, what would you make today?", type:"text" }
                ],
                archetypes: {
                    "Soft comfort (Rest)": { archetype: "The Compassionate Gardener", advice: "Inspiration thrives in the space *after* effort. Give yourself permission to pause.", action: "Write a note of self-compassion.", theme: "theme-rest" },
                    "Hard truth (Kick)": { archetype: "The Bold Challenger", advice: "Resistance is the measure of importance. Stop looking for shortcuts and embrace the grind.", action: "Do the hardest task first.", theme: "theme-kick" },
                    "New input (Awe)": { archetype: "The Curious Alchemist", advice: "Your mind craves cross-pollination. Look at biology, history, or maps.", action: "Read a wikipedia article about a random topic.", theme: "theme-weird" },
                    "Just a distraction": { archetype: "The Playful Saboteur", advice: "Distraction is the mind processing. Embrace low-stakes fun.", action: "Doodle for 15 minutes.", theme: "theme-weird" }
                }
            }
            // Add other modes (brainstorm, organize) similarly if needed, abbreviated here for space.
        };

        // Jolts Content (Oblique Strategies)
        const jolts = [
            "Honor thy error as a hidden intention.",
            "Work at a different speed.",
            "Discard the most interesting part.",
            "What would your worst enemy do? Do that.",
            "Decorate, decorate, decorate.",
            "Turn it upside down.",
            "Define an area as 'safe' and use it as an anchor.",
            "Remove specifics and convert to ambiguities."
        ];

        /* --- APP STATE & FUNCTIONS --- */
        const appState = {
            user: {},
            mode: null,
            step: 0,
            answers: []
        };

        window.app = {
            init: function() {
                const profile = localStorage.getItem('userProfile');
                if (profile) {
                    appState.user = JSON.parse(profile);
                    document.getElementById('dashName').textContent = appState.user.name;
                    this.setView('dashboard');
                } else {
                    this.setView('onboarding');
                }

                // Handle Onboarding Submit
                document.getElementById('onboardForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('userName').value.trim();
                    if(name) {
                        appState.user = { name: name };
                        localStorage.setItem('userProfile', JSON.stringify(appState.user));
                        document.getElementById('dashName').textContent = name;
                        this.setView('dashboard');
                    }
                });
            },

            setView: function(id) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(`view-${id}`).classList.add('active');
            },

            goHome: function() {
                // Reset Theme
                document.body.className = ''; 
                this.setView('dashboard');
            },

            logout: function() {
                localStorage.removeItem('userProfile');
                localStorage.removeItem('savedSparks');
                location.reload();
            },

            /* --- WIZARD LOGIC --- */
            startMode: function(mode) {
                if(!content[mode]) {
                    this.alert("Coming Soon", "This mode is under construction.");
                    return;
                }
                appState.mode = mode;
                appState.step = 0;
                appState.answers = [];
                document.getElementById('wizardModeTitle').textContent = mode.toUpperCase();
                this.loadStep();
                this.setView('wizard');
            },

            loadStep: function() {
                const modeData = content[appState.mode];
                const stepData = modeData.steps[appState.step];
                const total = modeData.steps.length;
                
                // Progress
                document.getElementById('progressBar').style.width = `${((appState.step+1)/total)*100}%`;
                document.getElementById('questionText').textContent = stepData.q;
                
                const optsArea = document.getElementById('optionsArea');
                const textInput = document.getElementById('textInput');
                const nextBtn = document.getElementById('nextBtn');
                const textContainer = document.getElementById('textInputContainer');

                optsArea.innerHTML = '';
                textInput.value = '';
                textInput.classList.add('hidden');
                textContainer.classList.remove('burning'); // Reset animation
                nextBtn.style.opacity = 0.5; nextBtn.style.pointerEvents = 'none';

                if(stepData.type === 'choice') {
                    stepData.opts.forEach(opt => {
                        const btn = document.createElement('div');
                        btn.className = 'option-btn';
                        btn.textContent = opt;
                        btn.onclick = () => {
                            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            appState.answers[appState.step] = opt;
                            nextBtn.style.opacity = 1; nextBtn.style.pointerEvents = 'auto';
                        };
                        optsArea.appendChild(btn);
                    });
                } else {
                    textInput.classList.remove('hidden');
                    textInput.oninput = () => {
                        if(textInput.value.length > 3) {
                            nextBtn.style.opacity = 1; nextBtn.style.pointerEvents = 'auto';
                        }
                    };
                }
            },

            nextStep: function() {
                const modeData = content[appState.mode];
                const currentStepData = modeData.steps[appState.step];

                // Logic for Text Input "Burn" effect
                if(currentStepData.type === 'text') {
                    const textVal = document.getElementById('textInput').value;
                    appState.answers[appState.step] = textVal;
                    
                    if(currentStepData.burn) {
                        const container = document.getElementById('textInputContainer');
                        container.classList.add('burning');
                        // Wait for animation
                        setTimeout(() => this.advance(), 800);
                        return; 
                    }
                }

                this.advance();
            },

            advance: function() {
                appState.step++;
                if(appState.step < content[appState.mode].steps.length) {
                    this.loadStep();
                } else {
                    this.generateResult();
                }
            },

            /* --- RESULT LOGIC --- */
            generateResult: function() {
                this.setView('result');
                const modeData = content[appState.mode];
                const keyAnswer = appState.answers[0];
                let result = modeData.archetypes[keyAnswer] || {
                    archetype: "The Insight Generator",
                    advice: "Based on your inputs, reduce complexity and prioritize rest.",
                    action: "Write down 3 wins from last week.",
                    theme: "theme-rest"
                };

                // Apply Theme (Biofeedback)
                document.body.className = result.theme || '';

                // Populate UI
                document.getElementById('resArchetype').textContent = result.archetype;
                document.getElementById('resAction').textContent = result.action;
                document.getElementById('resActionBox').classList.remove('hidden');
                document.getElementById('resButtons').classList.remove('hidden');

                // Save temp for saving
                appState.currentResult = { 
                    mode: appState.mode, 
                    archetype: result.archetype, 
                    advice: result.advice, 
                    action: result.action 
                };

                // Typewriter
                const el = document.getElementById('resBody');
                el.textContent = '';
                let i = 0;
                const type = () => {
                    if(i < result.advice.length) {
                        el.innerHTML = result.advice.substring(0, i+1) + '<span class="cursor"></span>';
                        i++; setTimeout(type, 20);
                    } else { el.innerHTML = result.advice; }
                };
                type();
            },

            /* --- JOLTS LOGIC --- */
            triggerJolt: function() {
                const randomJolt = jolts[Math.floor(Math.random() * jolts.length)];
                document.body.className = 'theme-weird'; // Jolts get weird theme
                this.alert("‚ö° Creative Jolt", 
                    `<div style="font-size:1.5rem; font-weight:800; text-align:center; margin:20px 0;">"${randomJolt}"</div>
                     <p style="text-align:center; color:#cbd5e1;">Apply this rule to your work immediately.</p>`
                );
            },

            /* --- SAVING --- */
            saveResult: function() {
                if(!appState.currentResult) return;
                
                DataStore.saveSpark(appState.currentResult).then(() => {
                    this.alert("Saved! üíæ", "Your spark is safe in your library.");
                });
            },

            showSaved: function() {
                this.setView('saved');
                const list = document.getElementById('savedList');
                list.innerHTML = '<div style="text-align:center; color:#94a3b8;">Loading...</div>';

                DataStore.getSparks((sparks) => {
                    list.innerHTML = '';
                    if(sparks.length === 0) {
                        list.innerHTML = '<div style="text-align:center; padding:20px; color:#cbd5e1;">No sparks yet. Go explore a mode!</div>';
                        return;
                    }
                    
                    sparks.forEach(s => {
                        const el = document.createElement('div');
                        el.className = 'spark-item';
                        el.innerHTML = `
                             <div style="font-size:0.8rem; color:var(--secondary); font-weight:700; display:flex; justify-content:space-between; margin-bottom:5px;">
                                <span>${s.mode.toUpperCase()}</span> 
                                <span>${new Date(s.timestamp).toLocaleDateString()}</span>
                            </div>
                            <div style="font-size:1.2rem; font-weight:800; color:white; margin-bottom:5px;">${s.archetype}</div>
                            <div style="font-size:0.9rem; color:#cbd5e1;">${s.action}</div>
                        `;
                        el.onclick = () => this.alert(s.archetype, `<p>${s.advice}</p><strong style="color:var(--primary)">Action: ${s.action}</strong>`);
                        list.appendChild(el);
                    });
                });
            },

            /* --- MODAL UTILS --- */
            alert: function(title, html) {
                const m = document.getElementById('genericModal');
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalBody').innerHTML = html;
                m.classList.add('open');
            },
            closeModal: function() {
                document.getElementById('genericModal').classList.remove('open');
            },
            openStory: function() {
                this.alert("Born from Struggle", `
                    <p class="story-text">In 2025, a team joined <a href="#" style="color:#ec4899">The Creative Mess</a>. We realized creativity isn't magic; it's a cycle.</p>
                    <p class="story-text">Creative Pulse diagnoses your block and offers specific feedback. No fluff.</p>
                    <div style="margin-top:20px; font-size:0.9rem; color:#cbd5e1; text-align:center;">Built by <b>EKOLiTiKA</b></div>
                `);
            }
        };

        // Start App
        window.app.init();
    </script>
</body>
</html>
